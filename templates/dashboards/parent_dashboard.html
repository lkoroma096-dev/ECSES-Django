{% extends 'base.html' %}
{% load static %}

{% block title %}Parent Dashboard - ECSES{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-home me-2"></i>Parent Dashboard
        </h1>
    </div>
</div>

<!-- Parent Overview Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ my_children_count }}</h4>
                        <p class="card-text">My Children</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-child fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ recent_progress_reports }}</h4>
                        <p class="card-text">Recent Reports</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ unread_messages }}</h4>
                        <p class="card-text">New Messages</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-envelope fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ total_badges }}</h4>
                        <p class="card-text">Badges Earned</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-medal fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Children Management Section -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-child me-2"></i>My Children Management
                </h5>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addChildModal">
                        <i class="fas fa-plus me-1"></i>Add Child
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="refreshChildren()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Filter Section -->
                <div class="row mb-3">
                    <div class="col-md-12">
                        <div class="btn-group mb-2" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="filterChildren('all')">All Children</button>
                            <button type="button" class="btn btn-outline-success" onclick="filterChildren('active')">Active</button>
                            <button type="button" class="btn btn-outline-info" onclick="filterChildren('age-0-12')">Age 0-12 months</button>
                            <button type="button" class="btn btn-outline-warning" onclick="filterChildren('age-13-24')">Age 13-24 months</button>
                            <button type="button" class="btn btn-outline-danger" onclick="filterChildren('age-25+')">Age 25+ months</button>
                        </div>
                    </div>
                </div>
                
                {% if my_children %}
                <div class="row" id="childrenContainer">
                    {% for child in my_children %}
                    <div class="col-md-6 col-lg-4 mb-3 child-card" data-status="{% if child.is_active %}active{% else %}inactive{% endif %}" data-age="{{ child.age_in_months }}">
                        <div class="card border-primary h-100">
                            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                <h6 class="card-title mb-0">{{ child.first_name }} {{ child.last_name }}</h6>
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{% url 'earlycare:child_detail' child.id %}">
                                            <i class="fas fa-eye me-2"></i>View Details
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="editChild({{ child.id }})">
                                            <i class="fas fa-edit me-2"></i>Edit Child
                                        </a></li>
                                        <li><a class="dropdown-item" href="#" onclick="viewChildAnalytics({{ child.id }})">
                                            <i class="fas fa-chart-line me-2"></i>View Analytics
                                        </a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteChild({{ child.id }}, '{{ child.first_name }} {{ child.last_name }}')">
                                            <i class="fas fa-trash me-2"></i>Delete Child
                                        </a></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <small class="text-muted">Age</small>
                                        <div class="fw-bold">{{ child.age_in_months }} months</div>
                                    </div>
                                    <div class="col-6">
                                        <small class="text-muted">Gender</small>
                                        <div class="fw-bold">{{ child.get_gender_display }}</div>
                                    </div>
                                </div>
                                
                                <!-- Progress indicators -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">Overall Progress</small>
                                        <small class="fw-bold">{{ child.overall_progress|default:0 }}%</small>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-success" style="width: {{ child.overall_progress|default:0 }}%"></div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <small class="text-muted">Activity Completion</small>
                                        <small class="fw-bold">{{ child.activity_completion|default:0 }}%</small>
                                    </div>
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-info" style="width: {{ child.activity_completion|default:0 }}%"></div>
                                    </div>
                                </div>
                                
                                <!-- Recent badges -->
                                <div class="mb-3">
                                    <small class="text-muted d-block mb-1">Recent Badges:</small>
                                    <div>
                                        {% for badge in child.recent_badges %}
                                        <span class="badge bg-warning me-1" title="{{ badge.badge.name }}">
                                            <i class="fas fa-medal"></i> {{ badge.badge.name }}
                                        </span>
                                        {% empty %}
                                        <small class="text-muted">No recent badges</small>
                                        {% endfor %}
                                    </div>
                                </div>
                                
                                <!-- Status indicators -->
                                <div class="row text-center">
                                    <div class="col-4">
                                        <div class="text-success">
                                            <i class="fas fa-check-circle"></i>
                                            <small class="d-block">Active</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-info">
                                            <i class="fas fa-user-graduate"></i>
                                            <small class="d-block">Learning</small>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <div class="text-warning">
                                            <i class="fas fa-star"></i>
                                            <small class="d-block">Progress</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer bg-light">
                                <div class="row">
                                    <div class="col-6">
                                        <a href="{% url 'earlycare:child_detail' child.id %}" class="btn btn-sm btn-primary w-100">
                                            <i class="fas fa-eye me-1"></i>View
                                        </a>
                                    </div>
                                    <div class="col-6">
                                        <button class="btn btn-sm btn-outline-success w-100" onclick="viewChildAnalytics({{ child.id }})">
                                            <i class="fas fa-chart-line me-1"></i>Analytics
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-child fa-4x mb-3 text-muted"></i>
                    <h5>No children registered yet</h5>
                    <p class="mb-4">Start by adding your first child to track their development and progress.</p>
                    <button type="button" class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addChildModal">
                        <i class="fas fa-user-plus me-2"></i>Add Your First Child
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Analytics Dashboard -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line me-2"></i>Children Analytics Dashboard
                </h5>
            </div>
            <div class="card-body">
                {% if my_children %}
                <div class="row">
                    <!-- Overall Progress Chart -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="card-title mb-0">Overall Progress Trends</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="progressChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Activity Completion Chart -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-success">
                            <div class="card-header bg-success text-white">
                                <h6 class="card-title mb-0">Activity Completion Rates</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="activityChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Badge Distribution -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-white">
                                <h6 class="card-title mb-0">Badge Distribution</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="badgeChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Development Milestones -->
                    <div class="col-md-6 mb-4">
                        <div class="card border-primary">
                            <div class="card-header bg-primary text-white">
                                <h6 class="card-title mb-0">Development Milestones</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="milestoneChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Analytics Summary Cards -->
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card bg-gradient-primary text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-trophy fa-2x mb-2"></i>
                                <h4>{{ total_badges }}</h4>
                                <p class="mb-0">Total Badges Earned</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-gradient-success text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-line fa-2x mb-2"></i>
                                <h4>{{ recent_progress_reports }}</h4>
                                <p class="mb-0">Progress Reports</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-gradient-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-calendar-check fa-2x mb-2"></i>
                                <h4>{{ my_children_count }}</h4>
                                <p class="mb-0">Active Children</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-gradient-warning text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-star fa-2x mb-2"></i>
                                <h4>{{ avg_completion_rate|default:0 }}%</h4>
                                <p class="mb-0">Avg. Completion Rate</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-chart-line fa-3x mb-3"></i>
                    <h5>No Analytics Available</h5>
                    <p>Add children to start tracking their progress and view analytics.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Messages and Feedback Log -->
<div class="row">
    <!-- Messages and Feedback -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-envelope me-2"></i>Messages & Feedback
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for message in recent_messages %}
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">{{ message.sender.get_full_name|default:message.sender.username }}</div>
                            <small>{{ message.subject|truncatechars:40 }}</small>
                            <br>
                            <small class="text-muted">{{ message.created_at|timesince }} ago</small>
                        </div>
                        {% if not message.is_read %}
                        <span class="badge bg-primary rounded-pill">New</span>
                        {% endif %}
                    </div>
                    {% empty %}
                    <div class="text-center text-muted">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>No recent messages</p>
                    </div>
                    {% endfor %}
                </div>
                <hr>
                <div class="d-grid">
                    <a href="{% url 'connecthub:inbox' %}" class="btn btn-primary">
                        <i class="fas fa-envelope me-2"></i>View All Messages
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Overview -->
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bell me-2"></i>Notifications Overview
                </h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush">
                    {% for notification in recent_notifications %}
                    <div class="list-group-item d-flex justify-content-between align-items-start">
                        <div class="ms-2 me-auto">
                            <div class="fw-bold">{{ notification.title }}</div>
                            <small>{{ notification.message|truncatechars:50 }}</small>
                            <br>
                            <small class="text-muted">{{ notification.created_at|timesince }} ago</small>
                        </div>
                        <span class="badge bg-{{ notification.notification_type }} rounded-pill">
                            {{ notification.get_notification_type_display }}
                        </span>
                    </div>
                    {% empty %}
                    <div class="text-center text-muted">
                        <i class="fas fa-bell-slash fa-2x mb-2"></i>
                        <p>No notifications</p>
                    </div>
                    {% endfor %}
                </div>
                <hr>
                <div class="d-grid">
                    <a href="{% url 'connecthub:notifications' %}" class="btn btn-outline-primary">
                        <i class="fas fa-bell me-2"></i>View All Notifications
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Support Plan Tracker -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-clipboard-list me-2"></i>Support Plan Tracker
                </h5>
            </div>
            <div class="card-body">
                {% if support_plans %}
                <div class="row">
                    {% for plan in support_plans %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="card-title mb-0">{{ plan.child.first_name }} {{ plan.child.last_name }}</h6>
                            </div>
                            <div class="card-body">
                                <p class="card-text">
                                    <strong>Status:</strong> 
                                    <span class="badge bg-{{ plan.status|default:'secondary' }}">
                                        {{ plan.get_status_display }}
                                    </span>
                                </p>
                                <p class="card-text">
                                    <strong>Goals:</strong><br>
                                    <small>{{ plan.goals|truncatechars:100 }}</small>
                                </p>
                                {% if plan.next_review %}
                                <p class="card-text">
                                    <strong>Next Review:</strong><br>
                                    <small class="text-muted">{{ plan.next_review|date:"M d, Y" }}</small>
                                </p>
                                {% endif %}
                                <a href="{% url 'earlycare:support_plan' plan.child.id %}" class="btn btn-sm btn-info">
                                    <i class="fas fa-eye me-1"></i>View Plan
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-clipboard-list fa-3x mb-3"></i>
                    <p>No support plans available</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'earlycare:child_new' %}" class="btn btn-primary w-100">
                            <i class="fas fa-user-plus me-2"></i>Add Child
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'connecthub:compose_message' %}" class="btn btn-success w-100">
                            <i class="fas fa-envelope me-2"></i>Message Teacher
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'earlycare:reports' %}" class="btn btn-info w-100">
                            <i class="fas fa-chart-bar me-2"></i>View Reports
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="{% url 'learnlytics:activities' %}" class="btn btn-warning w-100">
                            <i class="fas fa-tasks me-2"></i>View Activities
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Add Child Modal -->
<div class="modal fade" id="addChildModal" tabindex="-1" aria-labelledby="addChildModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addChildModalLabel">
                    <i class="fas fa-user-plus me-2"></i>Add New Child
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addChildForm" method="post" action="{% url 'earlycare:child_new' %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="firstName" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="lastName" name="last_name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="dateOfBirth" class="form-label">Date of Birth *</label>
                            <input type="date" class="form-control" id="dateOfBirth" name="date_of_birth" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="gender" class="form-label">Gender *</label>
                            <select class="form-select" id="gender" name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="medicalConditions" class="form-label">Medical Conditions</label>
                        <textarea class="form-control" id="medicalConditions" name="medical_conditions" rows="3" placeholder="Any medical conditions or special needs"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="emergencyContact" class="form-label">Emergency Contact</label>
                            <input type="text" class="form-control" id="emergencyContact" name="emergency_contact" placeholder="Emergency contact name">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="emergencyPhone" class="form-label">Emergency Phone</label>
                            <input type="tel" class="form-control" id="emergencyPhone" name="emergency_phone" placeholder="Emergency contact phone">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Add Child
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Child Modal -->
<div class="modal fade" id="editChildModal" tabindex="-1" aria-labelledby="editChildModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editChildModalLabel">
                    <i class="fas fa-edit me-2"></i>Edit Child Information
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editChildForm" method="post">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editFirstName" class="form-label">First Name *</label>
                            <input type="text" class="form-control" id="editFirstName" name="first_name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editLastName" class="form-label">Last Name *</label>
                            <input type="text" class="form-control" id="editLastName" name="last_name" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editDateOfBirth" class="form-label">Date of Birth *</label>
                            <input type="date" class="form-control" id="editDateOfBirth" name="date_of_birth" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editGender" class="form-label">Gender *</label>
                            <select class="form-select" id="editGender" name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="M">Male</option>
                                <option value="F">Female</option>
                                <option value="O">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editMedicalConditions" class="form-label">Medical Conditions</label>
                        <textarea class="form-control" id="editMedicalConditions" name="medical_conditions" rows="3"></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="editEmergencyContact" class="form-label">Emergency Contact</label>
                            <input type="text" class="form-control" id="editEmergencyContact" name="emergency_contact">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="editEmergencyPhone" class="form-label">Emergency Phone</label>
                            <input type="tel" class="form-control" id="editEmergencyPhone" name="emergency_phone">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>Update Child
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteChildModal" tabindex="-1" aria-labelledby="deleteChildModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteChildModalLabel">
                    <i class="fas fa-exclamation-triangle me-2 text-warning"></i>Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete <strong id="childNameToDelete"></strong>?</p>
                <p class="text-danger"><small>This action cannot be undone and will remove all associated data including assessments, activities, and progress reports.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteChild">
                    <i class="fas fa-trash me-2"></i>Delete Child
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Child Analytics Modal -->
<div class="modal fade" id="childAnalyticsModal" tabindex="-1" aria-labelledby="childAnalyticsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="childAnalyticsModalLabel">
                    <i class="fas fa-chart-line me-2"></i>Child Analytics
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="analyticsContent">
                    <!-- Analytics content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart.js configuration
Chart.defaults.font.family = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
Chart.defaults.font.size = 12;

// Initialize charts when page loads
document.addEventListener('DOMContentLoaded', function() {
    {% if my_children %}
    initializeCharts();
    {% endif %}
});

function initializeCharts() {
    // Get data from children
    const childrenData = {
        names: [{% for child in my_children %}'{{ child.first_name }} {{ child.last_name }}',{% endfor %}],
        progress: [{% for child in my_children %}{{ child.overall_progress|default:0 }},{% endfor %}],
        activity: [{% for child in my_children %}{{ child.activity_completion|default:0 }},{% endfor %}],
        ages: [{% for child in my_children %}{{ child.age_in_months }},{% endfor %}]
    };
    
    // Progress Chart
    const progressCtx = document.getElementById('progressChart').getContext('2d');
    new Chart(progressCtx, {
        type: 'line',
        data: {
            labels: childrenData.names,
            datasets: [{
                label: 'Overall Progress',
                data: childrenData.progress,
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    display: true
                }
            }
        }
    });

    // Activity Chart
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    const completedCount = childrenData.activity.filter(a => a >= 70).length;
    const inProgressCount = childrenData.activity.filter(a => a >= 30 && a < 70).length;
    const notStartedCount = childrenData.activity.filter(a => a < 30).length;
    
    new Chart(activityCtx, {
        type: 'doughnut',
        data: {
            labels: ['Completed', 'In Progress', 'Not Started'],
            datasets: [{
                data: [completedCount, inProgressCount, notStartedCount],
                backgroundColor: ['#28a745', '#ffc107', '#dc3545']
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Badge Chart - showing children with badges
    const badgeCtx = document.getElementById('badgeChart').getContext('2d');
    new Chart(badgeCtx, {
        type: 'bar',
        data: {
            labels: childrenData.names,
            datasets: [{
                label: 'Progress Score',
                data: childrenData.progress,
                backgroundColor: '#ffc107'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // Milestone Chart - average development scores
    const milestoneCtx = document.getElementById('milestoneChart').getContext('2d');
    const avgProgress = childrenData.progress.length > 0 ? 
        childrenData.progress.reduce((a, b) => a + b, 0) / childrenData.progress.length : 0;
    
    new Chart(milestoneCtx, {
        type: 'radar',
        data: {
            labels: ['Overall Progress', 'Activity Completion', 'Development Milestones', 'Learning Progress', 'Social Skills'],
            datasets: [{
                label: 'Average Scores',
                data: [
                    avgProgress / 100 * 5,
                    childrenData.activity.length > 0 ? childrenData.activity.reduce((a, b) => a + b, 0) / childrenData.activity.length / 100 * 5 : 0,
                    avgProgress / 100 * 5 * 0.85,
                    avgProgress / 100 * 5 * 0.9,
                    avgProgress / 100 * 5 * 0.8
                ],
                borderColor: '#007bff',
                backgroundColor: 'rgba(0, 123, 255, 0.2)',
                pointBackgroundColor: '#007bff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5
                }
            }
        }
    });
}

// CRUD Operations
function editChild(childId) {
    // Load child data and populate edit form
    fetch(`/earlycare/child/${childId}/edit/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('editFirstName').value = data.first_name;
            document.getElementById('editLastName').value = data.last_name;
            document.getElementById('editDateOfBirth').value = data.date_of_birth;
            document.getElementById('editGender').value = data.gender;
            document.getElementById('editMedicalConditions').value = data.medical_conditions || '';
            document.getElementById('editEmergencyContact').value = data.emergency_contact || '';
            document.getElementById('editEmergencyPhone').value = data.emergency_phone || '';
            
            document.getElementById('editChildForm').action = `/earlycare/child/${childId}/edit/`;
            new bootstrap.Modal(document.getElementById('editChildModal')).show();
        })
        .catch(error => {
            console.error('Error loading child data:', error);
            alert('Error loading child data. Please try again.');
        });
}

function deleteChild(childId, childName) {
    document.getElementById('childNameToDelete').textContent = childName;
    document.getElementById('confirmDeleteChild').onclick = function() {
        fetch(`/earlycare/child/${childId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Error deleting child. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error deleting child:', error);
            alert('Error deleting child. Please try again.');
        });
    };
    new bootstrap.Modal(document.getElementById('deleteChildModal')).show();
}

function viewChildAnalytics(childId) {
    // Load child analytics data
    fetch(`/earlycare/child/${childId}/analytics/`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('analyticsContent').innerHTML = html;
            new bootstrap.Modal(document.getElementById('childAnalyticsModal')).show();
        })
        .catch(error => {
            console.error('Error loading analytics:', error);
            alert('Error loading analytics. Please try again.');
        });
}

function refreshChildren() {
    location.reload();
}

// Filter children function
function filterChildren(filterType) {
    const childCards = document.querySelectorAll('.child-card');
    
    childCards.forEach(card => {
        const status = card.getAttribute('data-status');
        const age = parseInt(card.getAttribute('data-age'));
        let show = false;
        
        switch(filterType) {
            case 'all':
                show = true;
                break;
            case 'active':
                show = status === 'active';
                break;
            case 'age-0-12':
                show = age >= 0 && age <= 12;
                break;
            case 'age-13-24':
                show = age >= 13 && age <= 24;
                break;
            case 'age-25+':
                show = age >= 25;
                break;
        }
        
        if (show) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
    
    // Update button states
    const buttons = document.querySelectorAll('.btn-group button');
    buttons.forEach(btn => {
        if (btn.textContent.toLowerCase().includes(filterType.replace('-', ' '))) {
            btn.classList.remove('btn-outline-primary', 'btn-outline-success', 'btn-outline-info', 'btn-outline-warning', 'btn-outline-danger');
            btn.classList.add('btn-primary', 'btn-success', 'btn-info', 'btn-warning', 'btn-danger');
        } else {
            btn.classList.remove('btn-primary', 'btn-success', 'btn-info', 'btn-warning', 'btn-danger');
            if (btn.textContent.includes('All')) {
                btn.classList.add('btn-outline-primary');
            } else if (btn.textContent.includes('Active')) {
                btn.classList.add('btn-outline-success');
            } else if (btn.textContent.includes('13-24')) {
                btn.classList.add('btn-outline-warning');
            } else if (btn.textContent.includes('25+')) {
                btn.classList.add('btn-outline-danger');
            } else {
                btn.classList.add('btn-outline-info');
            }
        }
    });
}

// Form validation
document.getElementById('addChildForm').addEventListener('submit', function(e) {
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const dateOfBirth = document.getElementById('dateOfBirth').value;
    const gender = document.getElementById('gender').value;
    
    if (!firstName || !lastName || !dateOfBirth || !gender) {
        e.preventDefault();
        alert('Please fill in all required fields.');
        return false;
    }
    
    // Validate date of birth
    const birthDate = new Date(dateOfBirth);
    const today = new Date();
    if (birthDate >= today) {
        e.preventDefault();
        alert('Date of birth must be in the past.');
        return false;
    }
});

document.getElementById('editChildForm').addEventListener('submit', function(e) {
    const firstName = document.getElementById('editFirstName').value.trim();
    const lastName = document.getElementById('editLastName').value.trim();
    const dateOfBirth = document.getElementById('editDateOfBirth').value;
    const gender = document.getElementById('editGender').value;
    
    if (!firstName || !lastName || !dateOfBirth || !gender) {
        e.preventDefault();
        alert('Please fill in all required fields.');
        return false;
    }
    
    // Validate date of birth
    const birthDate = new Date(dateOfBirth);
    const today = new Date();
    if (birthDate >= today) {
        e.preventDefault();
        alert('Date of birth must be in the past.');
        return false;
    }
});
</script>
{% endblock %}

